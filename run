#!/usr/bin/env bash
# Cross-platform Java runner for Bash (Linux/macOS/WSL/Git Bash) and Windows CMD
# For CMD usage, run the separate .bat version instead.

set -e

# Detect if we are running in Bash
if [ -n "$BASH_VERSION" ]; then
    TEST_FLAG=false

    # parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --test|-t)
                TEST_FLAG=true
                shift
                ;;
            *)
                echo "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    # Create temp dir
    TMP_DIR=$(mktemp -d)
    trap "rm -rf \"$TMP_DIR\"" EXIT

    echo "Compiling Java files into $TMP_DIR..."

    # Bash 3.x compatibility: find all .java files recursively
    JAVA_FILES=$(find . -name "*.java")
    javac -d "$TMP_DIR" -cp "libs/*" $JAVA_FILES

    # Classpath separator: ; on Windows, : on Unix
    if [[ "$OSTYPE" == "msys"* || "$OSTYPE" == "cygwin"* ]]; then
        CP="$TMP_DIR;libs/*"
    else
        CP="$TMP_DIR:libs/*"
    fi

    if [ "$TEST_FLAG" = true ]; then
        echo "Running Tests"
        java -cp "$CP" Program true
    else
        echo "Running Program"
        java -cp "$CP" Program
    fi

    exit 0
fi

REM ========================
REM Windows CMD section
REM ========================

@echo off
SETLOCAL ENABLEEXTENSIONS ENABLEDELAYEDEXPANSION

SET TEST_FLAG=false

:parse_args
IF "%~1"=="" GOTO args_done
IF /I "%~1"=="--test" SET TEST_FLAG=true & SHIFT & GOTO parse_args
IF /I "%~1"=="-t" SET TEST_FLAG=true & SHIFT & GOTO parse_args

ECHO Unknown option: %~1
EXIT /B 1
:args_done

SET TMP_DIR=%TEMP%\java_tmp_%RANDOM%
MKDIR "%TMP_DIR%"

ECHO Compiling Java files into %TMP_DIR%...

SET JAVA_FILES=
FOR /R %%f IN (*.java) DO (
    SET JAVA_FILES=!JAVA_FILES! "%%f"
)

javac -d "%TMP_DIR%" -cp "libs/*" !JAVA_FILES!

IF /I "%TEST_FLAG%"=="true" (
    ECHO Running Tests
    java -cp "%TMP_DIR%;libs/*" Program true
) ELSE (
    ECHO Running Program
    java -cp "%TMP_DIR%;libs/*" Program
)

RMDIR /S /Q "%TMP_DIR%"
ENDLOCAL
